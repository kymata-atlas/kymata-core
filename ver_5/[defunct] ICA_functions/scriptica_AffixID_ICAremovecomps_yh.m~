%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% RUN ICA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

clear

id='0170'   %subject

wkdir=['/imaging/yh01/lexchinese_meg/' id '/tr'];
cd(wkdir)

blocks={
      'part1'
      'part2'
      'part3'
      'part4'
     };
 
nr_blocks=length(blocks);

 for f=1:nr_blocks;
     block=blocks{f};

fname=sprintf('%s_%s_sss_movecomp_tr.fif',id,block)

addpath /imaging/local/spm_eeglab/
addpath /imaging/local/eeglab/

[p fstem ext] = fileparts(fname);

icafname=sprintf('%s-SPM-eeg.mat',fstem);

S.D=icafname; 
S.samppct=1;
S.excbad=1; %1 for EEG and 0 for mags and grds
S.args={'extended',1,'maxsteps',800,'pca',32};

D=spm_eeglab_runica_yh(S);
 end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%--Classify and Remove Artefact ICs-------------------------
%
% View raw data on blink- and pulse-sensitive channels,
%  compute IC activations, correlate with physiological 
%  signals, plot corr Z-scores, plot topographies,
%  classify ICs as blink, horizontal eye mov'ts, pulse,
%  and remove selected artefact components.

addpath /imaging/local/spm_eeglab/
addpath /imaging/local/eeglab/

clear

ica_class    = {'blink','horiz'}; % Artefact(s) to classify
ica_chans    = {'veog','heog'};     % Reference channels for correlations
ica_rem      = {'blink'};                 % Artefact(s) to remove 

blocks={
     'part1'
     'part2'
     'part3'
     'part4'
    };

id='0153';

wkdir=['/imaging/yh01/lexchinese_meg/' id '/tr'];
cd(wkdir)

nr_blocks=length(blocks);

 for f=1:nr_blocks;
     block=blocks{f};

rawfname=sprintf('%s_%s_sss_movecomp_tr.fif',id,block);
[p fstem ext] = fileparts(rawfname);

icafname=sprintf('ica_%s-SPM-eeg.mat',fstem);

D.fname=icafname; %Jason

				clear S; S.D = D.fname;
				S.mode     = {'both'};  % classify + remove
				S.artlabs  = ica_class;
				S.chanlabs = ica_chans;
				S.remlabs  = ica_rem;
				S.remfname = ['rem_' S.D];

				D = meg_ica_artefact_eeg(S);
 end


